#!/usr/bin/env bash
{{ template "helpers.sh" . }}

set -e

# Resolve active profile and merge basic + profile brew lists
{{- $profile := .profile | default "basic" }}
{{- $basicPackages := index .packages "basic" | default dict }}
{{- $profilePackages := dict }}
{{- if ne $profile "basic" }}
{{- $profilePackages = index .packages $profile | default dict }}
{{- end }}
{{- $allBrews := $basicPackages.brews | default list }}
{{- range (index $profilePackages "brews" | default list) }}{{ $allBrews = append $allBrews . }}{{ end }}

# Run post-install only if fabric-ai is in the brew list
{{- if has "fabric-ai" $allBrews }}  # Run post-install only if fabric-ai is in the brew list
setup_brew_path

if command -v fabric-ai >/dev/null 2>&1; then
    section "Post-Install: Fabric AI"

    readonly FABRIC_REPO_DIR="$HOME/git/fabric"          # Local clone of fabric patterns repo
    readonly FABRIC_TIMESTAMP="$HOME/.cache/fabric-last-update"  # File tracking last update time
    readonly UPDATE_INTERVAL_DAYS=7                       # Skip update if last run was within 7 days

    mkdir -p "$HOME/.cache"

    # Check if patterns need updating based on timestamp age
    needs_update=false
    if [ ! -f "$FABRIC_TIMESTAMP" ]; then
        needs_update=true
    else
        time_diff=$(( ($(date +%s) - $(cat "$FABRIC_TIMESTAMP")) / 86400 ))
        [ "$time_diff" -ge "$UPDATE_INTERVAL_DAYS" ] && needs_update=true
    fi

    if [ "$needs_update" = true ]; then
        [ -d "$FABRIC_REPO_DIR" ] && [ ! -d "$FABRIC_REPO_DIR/.git" ] && rm -rf "$FABRIC_REPO_DIR"  # Remove broken clone

        # Clone/update personal patterns repo (cloonix/fabric -> CUSTOM_PATTERNS_DIRECTORY)
        if [ ! -d "$FABRIC_REPO_DIR" ]; then
            mkdir -p "$HOME/git"
            try "Cloning custom patterns (cloonix/fabric)" git clone https://github.com/cloonix/fabric "$FABRIC_REPO_DIR"
        else
            try "Updating custom patterns (cloonix/fabric)" git -C "$FABRIC_REPO_DIR" pull
        fi

        # Sync official patterns via fabric-ai -U (danielmiessler/fabric -> PATTERNS_LOADER_GIT_REPO_URL)
        try "Updating official patterns (danielmiessler/fabric)" fabric-ai -U
        date +%s > "$FABRIC_TIMESTAMP"                  # Record update timestamp
    else
        success "Fabric patterns up-to-date (last updated $time_diff days ago)"
    fi
fi
{{- end }}
