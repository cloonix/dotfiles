#!/usr/bin/env bash
{{ template "helpers.sh" . }}

set -e

{{- $profile := .profile | default "basic" }}
{{- $basicPackages := index .packages "basic" | default dict }}
{{- $profilePackages := dict }}
{{- if ne $profile "basic" }}
{{- $profilePackages = index .packages $profile | default dict }}
{{- end }}

{{- $allBrews := $basicPackages.brews | default list }}
{{- range (index $profilePackages "brews" | default list) }}{{ $allBrews = append $allBrews . }}{{ end }}

{{/* Fabric AI post-install setup */}}
{{ if has "fabric-ai" $allBrews -}}
# Ensure Homebrew is in PATH (each run script starts in a fresh shell)
{{ if eq .chezmoi.os "darwin" -}}
if [ -f "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi
{{- end }}
{{ if eq .chezmoi.os "linux" -}}
if [ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
{{- end }}

if command -v fabric-ai >/dev/null 2>&1; then
    section "Post-Install: Fabric AI"
    
    # Time-based refresh: update only if older than 7 days
    readonly FABRIC_REPO_DIR="$HOME/git/fabric"
    readonly FABRIC_TIMESTAMP="$HOME/.cache/fabric-last-update"
    readonly UPDATE_INTERVAL_DAYS=7
    
    mkdir -p "$HOME/.cache"
    
    # Check if update is needed
    needs_update=false
    if [ ! -f "$FABRIC_TIMESTAMP" ]; then
        needs_update=true
    else
        last_update=$(cat "$FABRIC_TIMESTAMP")
        current_time=$(date +%s)
        time_diff=$(( (current_time - last_update) / 86400 ))
        if [ "$time_diff" -ge "$UPDATE_INTERVAL_DAYS" ]; then
            needs_update=true
        fi
    fi
    
    if [ "$needs_update" = true ]; then
        # Clone or update git repository
        # Remove directory if it exists but is not a valid git repo (e.g. failed previous clone)
        if [ -d "$FABRIC_REPO_DIR" ] && [ ! -d "$FABRIC_REPO_DIR/.git" ]; then
            rm -rf "$FABRIC_REPO_DIR"
        fi

        if [ ! -d "$FABRIC_REPO_DIR" ]; then
            progress "Cloning fabric patterns repository"
            mkdir -p "$HOME/git"
            if git clone https://github.com/cloonix/fabric "$FABRIC_REPO_DIR" >/dev/null 2>&1; then
                finish
            else
                failed
            fi
        else
            progress "Updating fabric patterns repository"
            if git -C "$FABRIC_REPO_DIR" pull >/dev/null 2>&1; then
                finish
            else
                failed
            fi
        fi

        # Update fabric-ai patterns
        progress "Updating fabric-ai patterns"
        if fabric-ai -U >/dev/null 2>&1; then
            finish
            # Save timestamp on success
            date +%s > "$FABRIC_TIMESTAMP"
        else
            failed
        fi
    else
        success "Fabric patterns up-to-date (last updated $time_diff days ago)"
    fi
fi
{{ end -}}

{{/* Add more post-install hooks here as needed */}}
{{/* Example:
{{ if has "docker" $allBrews -}}
if command -v docker >/dev/null 2>&1; then
    section "Post-Install: Docker"
    progress "Setting up Docker"
    # Docker setup commands here
    finish
fi
{{ end -}}
*/}}
