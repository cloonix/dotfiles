#!/usr/bin/env bash
{{ template "helpers.sh" . }}

set -e

{{- $profile := .profile | default "basic" }}
{{- $allCustomTools := list }}
{{- $basicCustom := (index .packages "basic").custom | default list }}
{{- range $basicCustom }}{{ $allCustomTools = append $allCustomTools . }}{{ end }}
{{- if ne $profile "basic" }}
{{- $profileCustom := (index .packages $profile).custom | default list }}
{{- range $profileCustom }}
{{- if not (has . $allCustomTools) }}{{ $allCustomTools = append $allCustomTools . }}{{ end }}
{{- end }}
{{- end }}

{{- if has "homebrew" $allCustomTools }}
{{- $installer := index .custom "homebrew" }}

section "Homebrew"

if ! command -v {{ $installer.check }} >/dev/null 2>&1; then
    progress "Installing Homebrew"
{{ if eq .chezmoi.os "linux" -}}
    if NONINTERACTIVE=1 /bin/bash -c "$(curl -fsSL {{ $installer.url }})" >/dev/null 2>&1; then
{{- else -}}
    if /bin/bash -c "$(curl -fsSL {{ $installer.url }})" >/dev/null 2>&1; then
{{- end }}
        finish
        setup_brew_path
    else
        failed
        exit 1
    fi
else
    success "Homebrew already installed"
    run "Updating Homebrew" brew update
fi

{{- end }}
