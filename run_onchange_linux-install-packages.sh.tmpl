{{ if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
# Install packages on Linux (APT + Homebrew)
# hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}
# profile: {{ .profile | default "dev" }}

set -e

{{- $profile := .profile | default "dev" }}
{{- $customInstallers := (index .packages $profile).custom }}
{{- $linuxPkgs := index .packages $profile "linux" | default dict }}
{{- $aptPackages := index $linuxPkgs "apt" | default list }}
{{- $brewPackages := index $linuxPkgs "brews" | default list }}
{{- $caskPackages := index $linuxPkgs "casks" | default list }}

echo "ðŸ“¦ Installing Linux Packages (Profile: {{ $profile }})"

# Install APT packages first (may be needed for curl-based installers)
{{ if $aptPackages -}}
if command -v apt-get >/dev/null 2>&1; then
    echo "Updating APT package list..."
    sudo apt-get update -qq
    
    echo "Installing APT packages..."
    sudo apt-get install -y {{ range $aptPackages }}{{ . }} {{ end }}
    echo "âœ“ APT packages installed"
else
    echo "âš  APT not found, skipping APT packages"
fi
{{ end -}}

# Install custom curl-based packages
{{ range $customInstallers -}}
{{- $installer := index $.custom . }}
if ! command -v {{ $installer.check }} >/dev/null 2>&1; then
    echo "Installing {{ . }}..."
    /bin/bash -c "$(curl -fsSL {{ $installer.url }})"
    {{ if eq . "homebrew" -}}
    # Add Homebrew to PATH
    if [ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
        eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
    fi
    {{ end -}}
    echo "âœ“ {{ . }} installed"
else
    echo "âœ“ {{ . }} already installed"
fi
{{ end }}

# Install Homebrew packages
{{ if or $brewPackages $caskPackages -}}
if command -v brew >/dev/null 2>&1; then
    echo "Installing Homebrew packages..."
    brew bundle --file=/dev/stdin <<EOF
{{ range $brewPackages -}}
brew {{ . | quote }}
{{ end -}}
{{ range $caskPackages -}}
cask {{ . | quote }}
{{ end -}}
EOF
    echo "âœ“ Homebrew packages installed"
fi
{{ end -}}

echo "âœ“ All packages installed successfully"
{{ end -}}
