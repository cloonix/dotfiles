{{ if eq .chezmoi.os "linux" -}}
#!/usr/bin/env bash
# hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}
# profile: {{ .profile | default "dev" }}
{{ template "helpers.sh" . }}

set -e

{{- $profile := .profile | default "dev" }}
{{- $customInstallers := (index .packages $profile).custom }}
{{- $linuxPkgs := index .packages $profile "linux" | default dict }}
{{- $aptPackages := index $linuxPkgs "apt" | default list }}
{{- $brewPackages := index $linuxPkgs "brews" | default list }}
{{- $caskPackages := index $linuxPkgs "casks" | default list }}

section "Linux Packages ({{ $profile }})"

# Install APT packages first (may be needed for curl-based installers)
{{ if $aptPackages -}}
if command -v apt-get >/dev/null 2>&1; then
    progress "Updating APT"
    if sudo apt-get update -qq >/dev/null 2>&1; then
        finish
    else
        failed
        exit 1
    fi

    progress "Installing APT packages ({{ $aptPackages | join ", " }})"
    if sudo apt-get install -y -qq {{ range $aptPackages }}{{ . }} {{ end }}>/dev/null 2>&1; then
        finish
    else
        failed
        exit 1
    fi
else
    warn "APT not found, skipping APT packages"
fi
{{ end -}}

# Install custom curl-based packages
{{ range $customInstallers -}}
{{- $installer := index $.custom . }}
if ! command -v {{ $installer.check }} >/dev/null 2>&1; then
    progress "Installing {{ . }}"
    if /bin/bash -c "$(curl -fsSL {{ $installer.url }})" >/dev/null 2>&1; then
        finish
        {{ if eq . "homebrew" -}}
        # Add Homebrew to PATH
        if [ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
            eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
        fi
        {{ end -}}
    else
        failed
        exit 1
    fi
else
    success "{{ . }} already installed"
fi
{{ end }}

# Install Homebrew packages
{{ if or $brewPackages $caskPackages -}}
if command -v brew >/dev/null 2>&1; then
    {{- $allBrewPkgs := list }}
    {{- range $brewPackages }}{{ $allBrewPkgs = append $allBrewPkgs . }}{{ end }}
    {{- range $caskPackages }}{{ $allBrewPkgs = append $allBrewPkgs . }}{{ end }}
    progress "Installing brew packages ({{ $allBrewPkgs | join ", " }})"
    if brew bundle --quiet --file=/dev/stdin <<EOF >/dev/null 2>&1
{{ range $brewPackages -}}
brew {{ . | quote }}
{{ end -}}
{{ range $caskPackages -}}
cask {{ . | quote }}
{{ end -}}
EOF
    then
        finish
    else
        failed
        exit 1
    fi
fi
{{ end -}}
{{ end -}}
