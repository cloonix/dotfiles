#!/usr/bin/env bash
{{ template "helpers.sh" . }}

CONFIG_FILE="$HOME/.config/chezmoi/gopass-files-local.conf"

# Skip if gopass not available
if ! command -v gopass >/dev/null 2>&1; then
    exit 0
fi

# Skip if config doesn't exist
if [[ ! -f "$CONFIG_FILE" ]]; then
    exit 0
fi

progress "Checking gopass files"

# Collect files that need copying
declare -a files_to_copy=()
declare -a existing_files=()

while IFS=: read -r gopass_path dest_path; do
    # Skip comments and empty lines
    [[ "$gopass_path" =~ ^[[:space:]]*# ]] && continue
    [[ -z "$gopass_path" ]] && continue
    
    # Trim whitespace
    gopass_path=$(echo "$gopass_path" | xargs)
    dest_path=$(echo "$dest_path" | xargs)
    
    # Expand tilde
    dest_path="${dest_path/#\~/$HOME}"
    
    files_to_copy+=("$gopass_path:$dest_path")
    
    # Check if exists
    if [[ -f "$dest_path" ]]; then
        existing_files+=("$dest_path")
    fi
done < "$CONFIG_FILE"

# Exit if no files to process
if [[ ${#files_to_copy[@]} -eq 0 ]]; then
    info "No files configured in gopass-files-local.conf"
    exit 0
fi

# Prompt once if any files exist
if [[ ${#existing_files[@]} -gt 0 ]]; then
    echo ""
    warn "The following files already exist:"
    for file in "${existing_files[@]}"; do
        echo "  - $file"
    done
    echo ""
    read -p "  [O]verwrite all, [S]kip existing, [Q]uit? " choice
    case "$choice" in
        [Oo]* ) 
            OVERWRITE=true
            info "Will overwrite existing files"
            ;;
        [Qq]* ) 
            info "Skipping gopass file copy"
            exit 0
            ;;
        * ) 
            OVERWRITE=false
            info "Will skip existing files"
            ;;
    esac
    echo ""
fi

# Copy files
for entry in "${files_to_copy[@]}"; do
    gopass_path="${entry%%:*}"
    dest_path="${entry##*:}"
    
    # Skip if exists and not overwriting
    if [[ -f "$dest_path" ]] && [[ "$OVERWRITE" != "true" ]]; then
        info "Skipping: $dest_path (already exists)"
        continue
    fi
    
    # Create parent directory
    mkdir -p "$(dirname "$dest_path")" 2>/dev/null
    
    # Copy from gopass
    if gopass fscopy "$gopass_path" "$dest_path" 2>/dev/null; then
        chmod 600 "$dest_path"
        success "Copied: $gopass_path â†’ $dest_path"
    else
        error "Failed to copy: $gopass_path"
    fi
done

finish
