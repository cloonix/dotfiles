#!/usr/bin/env bash
# Finalize dotfiles setup

echo ""
echo "üêö Finalization"

# Ensure Homebrew is in PATH
{{ if eq .chezmoi.os "darwin" -}}
if [ -f "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi
{{ else if eq .chezmoi.os "linux" -}}
if [ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
{{ end -}}

# Change shell to zsh (optional)
if command -v zsh >/dev/null 2>&1; then
    zsh_path=$(command -v zsh)
    current_shell="$SHELL"

    if [ "$current_shell" = "$zsh_path" ]; then
        echo "‚úì Default shell is zsh"
    else
        echo "Changing default shell to zsh..."
        # Add zsh to /etc/shells if not already there
        if ! grep -Fxq "$zsh_path" /etc/shells 2>/dev/null; then
            echo "Adding $zsh_path to /etc/shells..."
            echo "$zsh_path" | sudo tee -a /etc/shells >/dev/null
        fi
        
        if chsh -s "$zsh_path" 2>/dev/null; then
            echo "‚úì Shell changed to zsh (log out and back in for changes to take effect)"
        else
            # Try with sudo on Linux
            if sudo chsh -s "$zsh_path" "$USER" 2>/dev/null; then
                echo "‚úì Shell changed to zsh (log out and back in for changes to take effect)"
            else
                echo "‚ö† Failed to change shell automatically"
                echo "  Run manually: sudo chsh -s $zsh_path $USER"
            fi
        fi
    fi
else
    echo "‚Ñπ zsh not found (keeping current shell)"
fi

# Final completion message
echo ""
echo "‚úì Dotfiles setup complete!"
echo "  Host: {{ .chezmoi.hostname }}"
echo "  OS: {{ .chezmoi.os }}/{{ .chezmoi.arch }}"
echo ""
echo "üìù Manual steps remaining:"

{{- if lookPath "nvim" }}
echo "  ‚Ä¢ Open nvim - Lazy will auto-sync plugins"
{{- end }}

{{- if and (lookPath "vim") (not (lookPath "nvim")) }}
echo "  ‚Ä¢ Open vim and run :PlugInstall"
{{- end }}

{{- if lookPath "tmux" }}
echo "  ‚Ä¢ In tmux, press <prefix> + I to install plugins"
{{- end }}

echo ""
