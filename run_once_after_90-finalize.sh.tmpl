#!/usr/bin/env bash
{{ template "helpers.sh" . }}

section "Finalization"

# Ensure Homebrew is in PATH
{{ if eq .chezmoi.os "darwin" -}}
if [ -f "/opt/homebrew/bin/brew" ]; then
    eval "$(/opt/homebrew/bin/brew shellenv)"
fi
{{ else if eq .chezmoi.os "linux" -}}
if [ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
{{ end -}}

# Change shell to zsh
if command -v zsh >/dev/null 2>&1; then
    zsh_path=$(command -v zsh)
    current_shell="$SHELL"

    if [ "$current_shell" = "$zsh_path" ]; then
        success "Default shell is zsh"
    else
        progress "Changing shell to zsh"
        # Add zsh to /etc/shells if not already there
        if ! grep -Fxq "$zsh_path" /etc/shells 2>/dev/null; then
            echo "$zsh_path" | sudo tee -a /etc/shells >/dev/null
        fi

        if chsh -s "$zsh_path" 2>/dev/null; then
            finish
            info "Log out and back in for changes to take effect"
        else
            if sudo chsh -s "$zsh_path" "$USER" 2>/dev/null; then
                finish
                info "Log out and back in for changes to take effect"
            else
                failed
                warn "Run manually: sudo chsh -s $zsh_path $USER"
            fi
        fi
    fi
else
    info "zsh not found (keeping current shell)"
fi

# Final completion message
log "Dotfiles setup complete!"
info "Host: {{ .chezmoi.hostname }}"
info "OS: {{ .chezmoi.os }}/{{ .chezmoi.arch }}"

{{- if lookPath "nvim" }}
info "Open nvim - Lazy will auto-sync plugins"
{{- end }}

{{- if and (lookPath "vim") (not (lookPath "nvim")) }}
info "Open vim and run :PlugInstall"
{{- end }}

{{- if lookPath "tmux" }}
info "In tmux, press <prefix> + I to install plugins"
{{- end }}
