#!/usr/bin/env bash
{{ template "helpers.sh" . }}

set -e

{{- $profile := .profile | default "basic" }}

section "Frameworks"

prezto_dir="${ZDOTDIR:-{{ .chezmoi.homeDir }}}/.zprezto"
if [ -d "$prezto_dir" ]; then
    try "Updating Prezto" git -C "$prezto_dir" pull --quiet
    try "Updating Prezto submodules" git -C "$prezto_dir" submodule update --init --recursive --quiet
else
    run "Installing Prezto" git clone --recursive --quiet https://github.com/sorin-ionescu/prezto.git "$prezto_dir"
fi

{{- if or (eq $profile "dev") (eq $profile "mac") }}
if command -v gopass >/dev/null 2>&1; then
    section "gopass"
    gopass config show.safecontent true >/dev/null 2>&1
    gopass config show.autoclip false >/dev/null 2>&1
    gopass config core.notifications false >/dev/null 2>&1

    current_pushurls=$(gopass git config --get-all remote.origin.pushurl 2>/dev/null | grep -v "^⚠" | sort)
    expected_pushurls=$(printf "%s\n%s" {{ .gopass_push_url_1 | quote }} {{ .gopass_push_url_2 | quote }} | sort)
    if [ "$current_pushurls" != "$expected_pushurls" ]; then
        gopass git remote set-url --push origin {{ .gopass_push_url_1 | quote }} >/dev/null 2>&1
        gopass git remote set-url --add --push origin {{ .gopass_push_url_2 | quote }} >/dev/null 2>&1
    fi
    success "gopass configured"
else
    info "gopass not found, skipping"
fi
{{- end }}

section "Finalization"

setup_brew_path

if command -v zsh >/dev/null 2>&1; then
    zsh_path=$(command -v zsh)
    if [ "$SHELL" = "$zsh_path" ]; then
        success "Default shell is zsh"
    else
        grep -Fxq "$zsh_path" /etc/shells 2>/dev/null || echo "$zsh_path" | sudo tee -a /etc/shells >/dev/null
        if chsh -s "$zsh_path" 2>/dev/null || sudo chsh -s "$zsh_path" "$USER" 2>/dev/null; then
            success "Shell changed to zsh (re-login to activate)"
        else
            warn "Could not change shell — run manually: sudo chsh -s $zsh_path $USER"
        fi
    fi
else
    info "zsh not found, keeping current shell"
fi

# Build next-steps list dynamically
next_steps=()
next_steps+=("Restart shell: exec zsh")
{{- if lookPath "nvim" }}
next_steps+=("Open nvim — Lazy will auto-sync plugins")
{{- end }}
{{- if and (lookPath "vim") (not (lookPath "nvim")) }}
next_steps+=("Open vim and run :PlugInstall")
{{- end }}
{{- if lookPath "tmux" }}
next_steps+=("In tmux: <prefix> + I to install plugins")
{{- end }}

summary_box "Dotfiles setup complete — {{ .chezmoi.hostname }} ({{ .chezmoi.os }}/{{ .chezmoi.arch }})" "${next_steps[@]}"
