#!/usr/bin/env bash
{{ template "helpers.sh" . }}

CONFIG_FILE="{{ .chezmoi.homeDir }}/.config/chezmoi/chezmoi.toml"

# Skip if config already exists
if [[ -f "$CONFIG_FILE" ]]; then
    info "Config already exists at $CONFIG_FILE"
    exit 0
fi

# Skip if gopass not available
if ! command -v gopass >/dev/null 2>&1; then
    warn "gopass not available, cannot retrieve config automatically"
    echo ""
    error "Please create config file manually at: $CONFIG_FILE"
    info "Or install gopass and run 'chezmoi init' again"
    echo ""
    exit 1  # Exit to prevent template errors
fi

section "Chezmoi Config Setup"

# Prompt for config name
echo ""
echo "Available config profiles:"
echo "  1) basic  - Minimal setup for any machine"
echo "  2) dev    - Full dev environment (Linux)"
echo "  3) mac    - macOS workstation"
echo ""
printf "Select config profile [1-3] (or press Enter to skip): "
read -r choice

case "$choice" in
    1) CONFIG_NAME="basic" ;;
    2) CONFIG_NAME="dev" ;;
    3) CONFIG_NAME="mac" ;;
    "")
        warn "Config selection skipped"
        echo ""
        error "Config file is required to continue"
        info "Please run 'chezmoi init' again and select a profile"
        info "Or create config manually at: $CONFIG_FILE"
        echo ""
        exit 1  # Exit to prevent template errors
        ;;
    *)
        warn "Invalid choice"
        echo ""
        error "Config file is required to continue"
        info "Please run 'chezmoi init' again and select a valid profile (1-3)"
        echo ""
        exit 1  # Exit to prevent template errors
        ;;
esac

GOPASS_PATH="config/chezmoi/${CONFIG_NAME}.toml"

progress "Fetching config from gopass: $GOPASS_PATH"

# Create config directory
mkdir -p "{{ .chezmoi.homeDir }}/.config/chezmoi"

# Copy from gopass
if gopass fscopy "$GOPASS_PATH" "$CONFIG_FILE" 2>/dev/null; then
    chmod 600 "$CONFIG_FILE"
    finish
    success "Config retrieved: $CONFIG_NAME profile"
    echo ""
    info "Config created successfully!"
    info "Run 'chezmoi apply' now to complete setup with the new config"
    echo ""
    exit 1  # Exit to stop chezmoi init - user must run 'chezmoi apply' next
else
    failed
    error "Failed to fetch config from gopass: $GOPASS_PATH"
    echo ""
    error "Config file is required to continue"
    info "Please verify the config exists in gopass and run 'chezmoi init' again"
    info "Or create config manually at: $CONFIG_FILE"
    echo ""
    exit 1  # Exit to prevent template errors
fi
