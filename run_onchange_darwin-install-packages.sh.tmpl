{{ if eq .chezmoi.os "darwin" -}}
#!/usr/bin/env bash
# hash: {{ include ".chezmoidata/packages.yaml" | sha256sum }}
# profile: {{ .profile | default "dev" }}
{{ template "helpers.sh" . }}

set -e

{{- $profile := .profile | default "dev" }}
{{- $customInstallers := (index .packages $profile).custom }}

section "macOS Packages ({{ $profile }})"

# Install custom curl-based packages
{{ range $customInstallers -}}
{{- $installer := index $.custom . }}
if ! command -v {{ $installer.check }} >/dev/null 2>&1; then
    progress "Installing {{ . }}"
    if /bin/bash -c "$(curl -fsSL {{ $installer.url }})" >/dev/null 2>&1; then
        finish
        {{ if eq . "homebrew" -}}
        # Add Homebrew to PATH for Apple Silicon Macs
        if [ -f "/opt/homebrew/bin/brew" ]; then
            eval "$(/opt/homebrew/bin/brew shellenv)"
        fi
        {{ end -}}
    else
        failed
        exit 1
    fi
else
    success "{{ . }} already installed"
fi
{{ end }}

# Install Homebrew packages for selected profile
progress "Installing brew packages"
if brew bundle --quiet --file=/dev/stdin <<EOF
{{ range (index .packages $profile "darwin").brews -}}
brew {{ . | quote }}
{{ end -}}
{{ range (index .packages $profile "darwin").casks -}}
cask {{ . | quote }}
{{ end -}}
EOF
then
    finish
else
    failed
    exit 1
fi
{{ end -}}
