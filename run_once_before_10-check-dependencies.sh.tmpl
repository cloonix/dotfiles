#!/bin/zsh
# Check required dependencies before installation

{{- template "helpers.sh" . }}

check_dependencies() {
    local required=("$@")
    local missing=()

    for bin in "${required[@]}"; do
        if command -v "$bin" >/dev/null 2>&1; then
            success "$bin found"
        else
            warn "$bin missing"
            missing+=("$bin")
        fi
    done

    if (( ${#missing[@]} > 0 )); then
        echo -e "\n${RED}❌ Missing dependencies:${NC}"
        printf '  - %s\n' "${missing[@]}"
        echo -e "\n${CYAN}${BOLD}=== Installation Instructions ===${NC}"

{{- if eq .chezmoi.os "darwin" }}
        echo -e "${GREEN}macOS (Homebrew):${NC}"
        echo "  brew install ${missing[*]}"
{{- else if eq .chezmoi.os "linux" }}
        echo -e "${GREEN}Ubuntu/Debian:${NC}"
        echo "  sudo apt update && sudo apt install ${missing[*]}"
        echo -e "\n${GREEN}CentOS/RHEL/Fedora:${NC}"
        echo "  sudo yum install ${missing[*]}"
{{- else }}
        echo -e "${YELLOW}Please install: ${missing[*]}${NC}"
{{- end }}
        echo ""
        return 1
    fi
    return 0
}

header "Checking Dependencies"

check_dependencies git curl vim tmux zsh

{{- if lookPath "nvim" }}
version=$(nvim --version | head -n1 | grep -o 'v[0-9]\+\.[0-9]\+' | sed 's/v//')
major=$(echo "$version" | cut -d. -f1)
minor=$(echo "$version" | cut -d. -f2)

if (( major > 0 || (major == 0 && minor >= 11) )); then
    check_dependencies fzf fd
    success "nvim $version ready"
else
    warn "nvim $version < 0.11, skipping"
fi
{{- else }}
warn "nvim not found, skipping"
{{- end }}
