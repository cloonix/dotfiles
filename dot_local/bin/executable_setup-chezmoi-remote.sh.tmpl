#!/usr/bin/env bash
set -euo pipefail

# Script to set up chezmoi on a remote host.
#
# Strategy for secrets:
#   Templates are rendered LOCALLY (where gopass is available) using
#   'chezmoi archive' with OS/arch/homeDir overridden to match the remote.
#   The resulting tarball contains already-rendered dotfiles with secrets
#   baked in. It is copied to the remote and extracted before chezmoi runs,
#   so run_after_* scripts never need gopass on the remote.
#
#   chezmoi.toml is generated from .chezmoi.toml.tmpl locally and streamed
#   to the remote — no gopass needed there.

show_usage() {
  cat << EOF
Usage: $(basename "$0") [OPTIONS] <ssh-target>

Set up chezmoi on a remote host via SSH.

Arguments:
  ssh-target              SSH target in user@host format or SSH hostname/alias (required)

Options:
  -c, --config NAME       Profile: basic, dev, or mac (default: basic)
  -r, --repo REPO         Git repository for chezmoi (default: cloonix)
  -b, --branch BRANCH     Git branch to use (optional, uses repo default if not specified)
  -u, --remote-user USER  Remote username (default: detected via SSH whoami)
  -a, --arch ARCH         Remote CPU architecture: amd64, arm64 (default: amd64)
  -h, --help              Show this help message and exit

Examples:
  $(basename "$0") dev
  $(basename "$0") -c dev user@192.168.1.100
  $(basename "$0") -c dev -b feature-branch -r cloonix root@example.com
  $(basename "$0") -c dev -u claus -a arm64 my-server

EOF
}

# Default values
CONFIG_NAME="basic"
CHEZMOI_REPO="cloonix"
CHEZMOI_BRANCH=""
REMOTE_USER=""
REMOTE_ARCH="amd64"
SSH_TARGET=""

# Parse command line options
while [[ $# -gt 0 ]]; do
  case "$1" in
    -h|--help)
      show_usage
      exit 0
      ;;
    -c|--config)
      [[ -z "${2:-}" ]] && { echo "Error: --config requires an argument" >&2; exit 1; }
      CONFIG_NAME="$2"
      shift 2
      ;;
    -r|--repo)
      [[ -z "${2:-}" ]] && { echo "Error: --repo requires an argument" >&2; exit 1; }
      CHEZMOI_REPO="$2"
      shift 2
      ;;
    -b|--branch)
      [[ -z "${2:-}" ]] && { echo "Error: --branch requires an argument" >&2; exit 1; }
      CHEZMOI_BRANCH="$2"
      shift 2
      ;;
    -u|--remote-user)
      [[ -z "${2:-}" ]] && { echo "Error: --remote-user requires an argument" >&2; exit 1; }
      REMOTE_USER="$2"
      shift 2
      ;;
    -a|--arch)
      [[ -z "${2:-}" ]] && { echo "Error: --arch requires an argument" >&2; exit 1; }
      REMOTE_ARCH="$2"
      shift 2
      ;;
    -*)
      echo "Error: Unknown option: $1" >&2
      show_usage
      exit 1
      ;;
    *)
      if [[ -z "$SSH_TARGET" ]]; then
        SSH_TARGET="$1"
      else
        echo "Error: Unexpected argument: $1" >&2
        show_usage
        exit 1
      fi
      shift
      ;;
  esac
done

# Validate
[[ -z "$SSH_TARGET" ]] && { echo "Error: SSH target is required" >&2; show_usage; exit 1; }
[[ ! "$CONFIG_NAME" =~ ^(basic|dev|mac)$ ]] && { echo "Error: --config must be one of: basic, dev, mac" >&2; exit 1; }
[[ ! "$REMOTE_ARCH" =~ ^(amd64|arm64)$ ]] && { echo "Error: --arch must be one of: amd64, arm64" >&2; exit 1; }

# ---------------------------------------------------------------------------
# Detect remote username and home dir
# ---------------------------------------------------------------------------
detect_remote_info() {
  local ssh_target="$1"
  local user home_dir
  user=$(ssh -n "$ssh_target" "whoami" 2>/dev/null) || { echo "Error: Cannot connect to $ssh_target" >&2; exit 1; }
  home_dir=$(ssh -n "$ssh_target" "echo \$HOME" 2>/dev/null) || home_dir="/home/$user"
  echo "$user $home_dir"
}

# ---------------------------------------------------------------------------
# Render all dotfile templates locally and stream to remote.
#
# chezmoi archive is called with:
#   --config         → locally-rendered chezmoi.toml for the remote profile
#   --destination    → remote $HOME so paths render correctly
#   --override-data  → inject os/arch/homeDir to match the remote
#
# The archive is extracted on the remote BEFORE chezmoi init runs, so every
# secret-bearing file is already in place. Chezmoi sees no diff and skips them.
# ---------------------------------------------------------------------------
render_and_copy_dotfiles() {
  local config_toml="$1"
  local ssh_target="$2"
  local remote_home="$3"
  local remote_arch="$4"

  echo "Rendering templates locally for linux/$remote_arch (secrets from gopass)..."

  local override_json
  override_json=$(printf '{"chezmoi":{"os":"linux","arch":"%s","homeDir":"%s"}}' \
    "$remote_arch" "$remote_home")

  chezmoi archive \
    --config "$config_toml" \
    --destination "$remote_home" \
    --override-data "$override_json" \
    --format tar \
    | ssh "$ssh_target" "
        mkdir -p '$remote_home'
        tar -x --no-same-owner --overwrite -C '$remote_home'
        echo 'Dotfiles extracted to $remote_home'
      "

  echo "  Done — all templates rendered with local secrets and pushed to remote."
}

# ---------------------------------------------------------------------------
# Main
# ---------------------------------------------------------------------------
echo "Setting up chezmoi on $SSH_TARGET..."
echo "Profile: $CONFIG_NAME | Repo: $CHEZMOI_REPO"
[[ -n "$CHEZMOI_BRANCH" ]] && echo "Branch: $CHEZMOI_BRANCH"
echo ""

# Detect remote environment
echo "Detecting remote environment..."
read -r DETECTED_USER REMOTE_HOME <<< "$(detect_remote_info "$SSH_TARGET")"
[[ -z "$REMOTE_USER" ]] && REMOTE_USER="$DETECTED_USER"
echo "  Remote user: $REMOTE_USER"
echo "  Remote home: $REMOTE_HOME"
echo "  Remote arch: $REMOTE_ARCH"
echo ""

# Render chezmoi.toml locally from .chezmoi.toml.tmpl, injecting the profile.
# promptStringOnce is bypassed by supplying the answer via --override-data.
TEMP_CONFIG="/tmp/chezmoi-remote-$$.toml"
trap 'rm -f "$TEMP_CONFIG"' EXIT

echo "Rendering chezmoi.toml locally (profile: $CONFIG_NAME)..."
override_json=$(printf '{"chezmoi":{"os":"linux","arch":"%s","homeDir":"%s"},"profile":"%s"}' \
  "$REMOTE_ARCH" "$REMOTE_HOME" "$CONFIG_NAME")
chezmoi execute-template \
  --override-data "$override_json" \
  < "{{ .chezmoi.sourceDir }}/.chezmoi.toml.tmpl" \
  > "$TEMP_CONFIG"
echo "  Done"
echo ""

# Render and copy all dotfiles to remote
render_and_copy_dotfiles "$TEMP_CONFIG" "$SSH_TARGET" "$REMOTE_HOME" "$REMOTE_ARCH"
echo ""

# Build branch flag
BRANCH_FLAG=""
[[ -n "$CHEZMOI_BRANCH" ]] && BRANCH_FLAG="--branch $CHEZMOI_BRANCH"

# Stream the rendered config to the remote and run chezmoi
echo "Connecting to $SSH_TARGET and running chezmoi (packages + run scripts)..."
cat "$TEMP_CONFIG" | ssh "$SSH_TARGET" "
bash -l -c \"
  echo 'Installing curl and git...'
  if command -v apt-get >/dev/null 2>&1; then
    sudo apt-get update -qq && sudo apt-get install -y curl git
  elif command -v yum >/dev/null 2>&1; then
    sudo yum install -y curl git
  elif command -v brew >/dev/null 2>&1; then
    brew install curl git
  else
    echo 'Warning: Unknown package manager, assuming curl and git are installed'
  fi

  mkdir -p ~/.config/chezmoi
  cat > ~/.config/chezmoi/chezmoi.toml

  export NONINTERACTIVE=1
  export CI=1

  if [ -d ~/.local/share/chezmoi/.git ]; then
    echo 'Pulling latest changes...'
    git -C ~/.local/share/chezmoi pull
  fi

  echo 'Installing chezmoi and cloning repo...'
  bash -c \\\"\\\$(curl -fsLS get.chezmoi.io)\\\" -- init --force $BRANCH_FLAG $CHEZMOI_REPO

  echo 'Running chezmoi apply (run scripts only)...'
  export PATH=\$HOME/.local/bin:\$PATH
  chezmoi apply --force --exclude files
\""

echo ""
echo "Chezmoi setup complete on $SSH_TARGET"
