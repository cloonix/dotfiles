#!/usr/bin/env bash
{{ template "helpers.sh" . }}

set -e

AUTH_FILE="{{ .chezmoi.homeDir }}/.local/share/opencode/auth.json"
AUTH_DIR="$(dirname "$AUTH_FILE")"

# Skip if auth.json already exists (preserve runtime tokens)
if [[ -f "$AUTH_FILE" ]]; then
    exit 0
fi

# Skip if gopass not available
if ! command -v gopass >/dev/null 2>&1; then
    warn "gopass not available, skipping opencode auth setup"
    exit 0
fi

progress "Setting up initial opencode auth (refresh tokens only)"

mkdir -p "$AUTH_DIR"

# Retrieve refresh tokens
ANTHROPIC_REFRESH=$(gopass show --password api/anthropic-refresh 2>/dev/null || echo "")
COPILOT_REFRESH=$(gopass show --password api/github refresh 2>/dev/null || echo "")
ZEN_KEY=$(gopass show --password api/zen 2>/dev/null || echo "")
OPENROUTER_KEY=$(gopass show --password api/openrouter opencode 2>/dev/null || echo "")

# Create initial auth.json
cat > "$AUTH_FILE" <<EOF
{
  "anthropic": {
    "type": "oauth",
    "refresh": "$ANTHROPIC_REFRESH"
  },
  "github-copilot": {
    "type": "oauth",
    "refresh": "$COPILOT_REFRESH"
  },
  "opencode": {
    "type": "api",
    "key": "$ZEN_KEY"
  },
  "openrouter": {
    "type": "api",
    "key": "$OPENROUTER_KEY"
  }
}
EOF

chmod 600 "$AUTH_FILE"
finish
success "Created $AUTH_FILE with initial tokens"
