#!/usr/bin/env bash
{{ template "helpers.sh" . }}
{{ template "install_tool.sh" . }}

set -e

{{- $profile := .profile | default "basic" }}

{{/* Collect custom tools from basic + profile */}}
{{- $allCustomTools := list }}
{{- $basicCustom := (index .packages "basic").custom | default list }}
{{- range $basicCustom }}{{ $allCustomTools = append $allCustomTools . }}{{ end }}

{{- if ne $profile "basic" }}
{{- $profileCustom := (index .packages $profile).custom | default list }}
{{- range $profileCustom }}
{{- if not (has . $allCustomTools) }}{{ $allCustomTools = append $allCustomTools . }}{{ end }}
{{- end }}
{{- end }}

{{ if gt (len $allCustomTools) 0 -}}
section "Custom Tools ({{ $profile }})"

# Phase 1: Install tools that only run if missing (skip homebrew - handled in script 35)
{{- range $allCustomTools }}
{{- if ne . "homebrew" }}
{{- $installer := index $.custom . }}
{{- if eq $installer.install_when "missing" }}
# Generic install-once tool
install_tool "{{ . }}" "{{ $installer.url }}" "{{ $installer.check }}" "false"
if [ $? -ne 0 ]; then
    exit 1
fi
{{- end }}
{{- end }}
{{- end }}

# Phase 2: Install tools that always run (e.g., opencode, servicehub)
{{- range $allCustomTools }}
{{- $installer := index $.custom . }}
{{- if eq $installer.install_when "always" }}

# Check dependencies for {{ . }}
{{- if gt (len $installer.requires) 0 }}
DEPS_MET=true
{{- range $installer.requires }}
if ! command -v {{ . }} >/dev/null 2>&1; then
    warn "Skipping {{ $installer.check }}: requires {{ . }}"
    DEPS_MET=false
fi
{{- end }}

if [ "$DEPS_MET" = "true" ]; then
    install_tool "{{ . }}" "{{ $installer.url }}" "{{ $installer.check }}" "true"
    if [ $? -ne 0 ]; then
        exit 1
    fi
fi
{{- else }}
# No dependencies, install directly
install_tool "{{ . }}" "{{ $installer.url }}" "{{ $installer.check }}" "true"
if [ $? -ne 0 ]; then
    exit 1
fi
{{- end }}
{{- end }}
{{- end }}
{{- end }}
