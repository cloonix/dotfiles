#!/usr/bin/env bash
{{ template "helpers.sh" . }}
{{ template "install_tool.sh" . }}

set -e

{{- $profile := .profile | default "basic" }}
{{- $allCustomTools := list }}
{{- $basicCustom := (index .packages "basic").custom | default list }}
{{- range $basicCustom }}{{ $allCustomTools = append $allCustomTools . }}{{ end }}
{{- if ne $profile "basic" }}
{{- $profileCustom := (index .packages $profile).custom | default list }}
{{- range $profileCustom }}
{{- if not (has . $allCustomTools) }}{{ $allCustomTools = append $allCustomTools . }}{{ end }}
{{- end }}
{{- end }}

{{ if gt (len $allCustomTools) 0 -}}
section "Custom Tools ({{ $profile }})"

setup_brew_path

{{- range $allCustomTools }}
{{- if ne . "homebrew" }}
{{- $installer := index $.custom . }}

{{- if gt (len $installer.requires) 0 }}
deps_met_{{ . }}=true
{{- range $installer.requires }}
command -v {{ . }} >/dev/null 2>&1 || { warn "Skipping {{ . }}: requires {{ . }}"; deps_met_{{ . }}=false; }
{{- end }}
[ "$deps_met_{{ . }}" = "true" ] && install_tool "{{ . }}" "{{ $installer.url }}" "{{ $installer.check }}" "{{ if eq $installer.install_when "always" }}true{{ else }}false{{ end }}"
{{- else }}
install_tool "{{ . }}" "{{ $installer.url }}" "{{ $installer.check }}" "{{ if eq $installer.install_when "always" }}true{{ else }}false{{ end }}"
{{- end }}

{{- end }}
{{- end }}
{{- end }}
