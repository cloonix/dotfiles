#!/usr/bin/env bash
{{ template "helpers.sh" . }}

set -e

{{- $profile := .profile | default "basic" }}

{{/* Merge packages: basic + profile */}}
{{- $basicPackages := index .packages "basic" | default dict }}
{{- $profilePackages := dict }}
{{- if ne $profile "basic" }}
{{- $profilePackages = index .packages $profile | default dict }}
{{- end }}

{{- $allTaps := $basicPackages.taps | default list }}
{{- range (index $profilePackages "taps" | default list) }}{{ $allTaps = append $allTaps . }}{{ end }}

{{- $allApt := $basicPackages.apt | default list }}
{{- range (index $profilePackages "apt" | default list) }}{{ $allApt = append $allApt . }}{{ end }}

{{- $allBrews := $basicPackages.brews | default list }}
{{- range (index $profilePackages "brews" | default list) }}{{ $allBrews = append $allBrews . }}{{ end }}

{{- $allCasks := $basicPackages.casks | default list }}
{{- range (index $profilePackages "casks" | default list) }}{{ $allCasks = append $allCasks . }}{{ end }}

{{- $allNpm := $basicPackages.npm | default list }}
{{- range (index $profilePackages "npm" | default list) }}{{ $allNpm = append $allNpm . }}{{ end }}

{{ if eq .chezmoi.os "darwin" -}}
section "Packages ({{ $profile }})"

{{ if and (ne $profile "basic") (not $profilePackages) -}}
warn "Profile '{{ $profile }}' has no packages, installing basic only"
{{ end -}}

# Tap repositories first
{{ if gt (len $allTaps) 0 -}}
progress "Tapping brew repositories ({{ $allTaps | join ", " }})"
if brew bundle --quiet --file=/dev/stdin <<EOF >/dev/null 2>&1
{{ range $allTaps -}}
tap {{ . | quote }}
{{ end -}}
EOF
then
    finish
else
    failed
    exit 1
fi
{{ end -}}

{{- $allPkgs := list }}
{{- range $allBrews }}{{ $allPkgs = append $allPkgs . }}{{ end }}
{{- range $allCasks }}{{ $allPkgs = append $allPkgs . }}{{ end }}
{{ if gt (len $allPkgs) 0 -}}
progress "Installing/upgrading packages ({{ $allPkgs | join ", " }})"
if brew bundle --quiet --file=/dev/stdin <<EOF >/dev/null 2>&1
{{ range $allBrews -}}
brew {{ . | quote }}
{{ end -}}
{{ range $allCasks -}}
cask {{ . | quote }}
{{ end -}}
EOF
then
    finish
else
    failed
    exit 1
fi
{{ end -}}

{{ if gt (len $allNpm) 0 -}}
progress "Installing npm global packages ({{ $allNpm | join ", " }})"
if npm install -g {{ $allNpm | join " " }} >/dev/null 2>&1; then
    finish
else
    failed
    exit 1
fi
{{ end -}}

# Remind about shell restart for new tools to be available
info "New packages installed - restart shell after setup completes"
{{ end -}}

{{ if eq .chezmoi.os "linux" -}}
section "Packages ({{ $profile }})"

{{ if and (ne $profile "basic") (not $profilePackages) -}}
warn "Profile '{{ $profile }}' has no packages, installing basic only"
{{ end -}}

# Ensure Homebrew is in PATH if installed
if [ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
    eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi

# Install APT packages
{{ if gt (len $allApt) 0 -}}
progress "Installing APT packages ({{ $allApt | join ", " }})"
if sudo apt-get update -qq && sudo apt-get install -y {{ $allApt | join " " }} >/dev/null 2>&1; then
    finish
else
    failed
    exit 1
fi
{{ end -}}

# Tap repositories first
{{ if gt (len $allTaps) 0 -}}
progress "Tapping brew repositories ({{ $allTaps | join ", " }})"
if brew bundle --quiet --file=/dev/stdin <<EOF >/dev/null 2>&1
{{ range $allTaps -}}
tap {{ . | quote }}
{{ end -}}
EOF
then
    finish
else
    failed
    exit 1
fi
{{ end -}}

# Install Homebrew packages
{{ if gt (len $allBrews) 0 -}}
progress "Installing/upgrading brew packages ({{ $allBrews | join ", " }})"
if brew bundle --quiet --file=/dev/stdin <<EOF >/dev/null 2>&1
{{ range $allBrews -}}
brew {{ . | quote }}
{{ end -}}
EOF
then
    finish
else
    failed
    exit 1
fi
{{ end -}}

{{ if gt (len $allNpm) 0 -}}
progress "Installing npm global packages ({{ $allNpm | join ", " }})"
if npm install -g {{ $allNpm | join " " }} >/dev/null 2>&1; then
    finish
else
    failed
    exit 1
fi
{{ end -}}

# Remind about shell restart for new tools to be available
info "New packages installed - restart shell after setup completes"
{{ end -}}
