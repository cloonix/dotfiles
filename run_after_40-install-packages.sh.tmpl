#!/usr/bin/env bash
{{ template "helpers.sh" . }}

set -e

# Resolve active profile and load package lists for basic + current profile
{{- $profile := .profile | default "basic" }}
{{- $basicPackages := index .packages "basic" | default dict }}
{{- $profilePackages := dict }}
{{- if ne $profile "basic" }}
{{- $profilePackages = index .packages $profile | default dict }}
{{- end }}

# Merge basic + profile lists for each package manager
{{- $allTaps  := $basicPackages.taps  | default list }}
{{- range (index $profilePackages "taps"  | default list) }}{{ $allTaps  = append $allTaps  . }}{{ end }}
{{- $allApt   := $basicPackages.apt   | default list }}
{{- range (index $profilePackages "apt"   | default list) }}{{ $allApt   = append $allApt   . }}{{ end }}
{{- $allBrews := $basicPackages.brews | default list }}
{{- range (index $profilePackages "brews" | default list) }}{{ $allBrews = append $allBrews . }}{{ end }}
{{- $allCasks := $basicPackages.casks | default list }}
{{- range (index $profilePackages "casks" | default list) }}{{ $allCasks = append $allCasks . }}{{ end }}
{{- $allNpm   := $basicPackages.npm   | default list }}
{{- range (index $profilePackages "npm"   | default list) }}{{ $allNpm   = append $allNpm   . }}{{ end }}

section "Packages ({{ $profile }})"
{{ if and (ne $profile "basic") (not $profilePackages) -}}
warn "Profile '{{ $profile }}' has no packages, installing basic only"
{{ end -}}

{{ if eq .chezmoi.os "linux" -}}
setup_brew_path  # Make linuxbrew available on Linux before any brew commands
{{ if gt (len $allApt) 0 -}}
run "Installing APT packages" sh -c 'sudo apt-get update -qq && sudo apt-get install -y {{ $allApt | join " " }} >/dev/null 2>&1'  # Install system packages via apt
{{ end -}}
{{ end -}}

{{ if gt (len $allTaps) 0 -}}
run "Tapping brew repositories" brew bundle --quiet --file=/dev/stdin <<'EOF'  # Add third-party Homebrew taps
{{ range $allTaps -}}
tap {{ . | quote }}
{{ end -}}
EOF
{{ end -}}

{{- $allPkgs := concat $allBrews $allCasks }}
{{ if gt (len $allPkgs) 0 -}}
run "Installing/upgrading packages ({{ $allPkgs | join ", " }})" brew bundle --quiet --file=/dev/stdin <<'EOF'  # Install all brews and casks via Brewfile
{{ range $allBrews -}}
brew {{ . | quote }}
{{ end -}}
{{ range $allCasks -}}
cask {{ . | quote }}
{{ end -}}
EOF
{{ end -}}

{{ if gt (len $allNpm) 0 -}}
run "Installing npm global packages" npm install -g {{ $allNpm | join " " }}  # Install global npm tools
{{ end -}}

info "New packages installed - restart shell after setup completes"
