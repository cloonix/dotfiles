# ========================================
# Zsh Configuration File
# ========================================

{{- $profile := .profile | default "basic" }}

# ========================================
# Homebrew Setup (must be early for PATH)
# ========================================

{{- if eq .chezmoi.os "darwin" }}
if [ -f "/opt/homebrew/bin/brew" ]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi
{{- else if eq .chezmoi.os "linux" }}
if [ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
{{- end }}

# ========================================
# Agent Setup
# ========================================

# Start ssh-agent on login (Linux-specific)
# Skip if SSH_AUTH_SOCK is already set (indicates agent forwarding is active)
{{- if eq .chezmoi.os "linux" }}
if [[ -z "$SSH_AUTH_SOCK" ]] && command -v keychain >/dev/null 2>&1; then
  if [ -f "{{ .chezmoi.homeDir }}/.ssh/id_ed25519" ]; then
    keychain --nogui {{ .chezmoi.homeDir }}/.ssh/id_ed25519
  elif [ -f "{{ .chezmoi.homeDir }}/.ssh/id_rsa" ]; then
    keychain --nogui {{ .chezmoi.homeDir }}/.ssh/id_rsa
  fi
  if [ -f "{{ .chezmoi.homeDir }}/.keychain/{{ .chezmoi.hostname }}-sh" ]; then
    source {{ .chezmoi.homeDir }}/.keychain/{{ .chezmoi.hostname }}-sh
  fi
fi
{{- end }}

# Start gpg-agent if available
if command -v gpg-connect-agent >/dev/null 2>&1; then
  export GPG_TTY=$(tty)
  gpg-connect-agent updatestartuptty /bye &> /dev/null
fi

# Display system info with fastfetch if available
if command -v fastfetch >/dev/null 2>&1; then
  fastfetch
fi

# ========================================
# Framework Configuration
# ========================================

# Source Prezto (must load before Starship)
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

# ========================================
# Prompt Configuration
# ========================================

# Initialize Starship prompt (after Prezto)
if command -v starship >/dev/null 2>&1; then
  eval "$(starship init zsh)"
fi

# ========================================
# Completion Configuration
# ========================================

fpath+=~/.zsh/completions
autoload -Uz compinit
compinit

# ========================================
# Environment Variables (from gopass)
# ========================================

# Load environment variables from secure storage
# File is managed via gopass and copied during 'chezmoi apply'
if [[ -f "$HOME/.env" ]]; then
  source "$HOME/.env"
fi

# Set terminal type
export TERM=xterm-256color

# Set editor variables
if command -v nvim >/dev/null 2>&1; then
  export EDITOR=nvim
  export VISUAL=nvim
else
  export EDITOR=vim
  export VISUAL=vim
fi

# Add local bin to PATH
if [[ -d "$HOME/.local/bin" ]] && [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
  export PATH="$PATH:$HOME/.local/bin"
fi

{{- if or (eq $profile "dev") (eq $profile "mac") }}
# Add go bin to PATH (dev/mac profiles only)
if [[ -d "$HOME/go/bin" ]] && [[ ":$PATH:" != *":$HOME/go/bin:"* ]]; then
  export PATH="$PATH:$HOME/go/bin"
fi
{{- end }}

# opencode
if [[ -d "{{ .chezmoi.homeDir }}/.opencode/bin" ]] && [[ ":$PATH:" != *":{{ .chezmoi.homeDir }}/.opencode/bin:"* ]]; then
  export PATH="{{ .chezmoi.homeDir }}/.opencode/bin:$PATH"
fi

# Use eza as ls replacement (if available)
if command -v eza >/dev/null 2>&1; then
  alias ls="eza"
fi

# Source custom aliases
if [[ -f "$HOME/.aliases" ]]; then
  source "$HOME/.aliases"
fi

# History search keybinding
bindkey '^R' history-incremental-search-backward



# ========================================
# End of Configuration
# ========================================
