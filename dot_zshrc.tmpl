# ========================================
# Zsh Configuration File
# ========================================

# ========================================
# Agent Setup
# ========================================

# Start ssh-agent on login (Linux-specific)
{{- if eq .chezmoi.os "linux" }}
{{- if lookPath "keychain" }}
{{- if stat (joinPath .chezmoi.homeDir ".ssh/id_ed25519") }}
keychain --nogui {{ .chezmoi.homeDir }}/.ssh/id_ed25519
{{- else if stat (joinPath .chezmoi.homeDir ".ssh/id_rsa") }}
keychain --nogui {{ .chezmoi.homeDir }}/.ssh/id_rsa
{{- end }}
{{- if stat (joinPath .chezmoi.homeDir ".keychain" (printf "%s-sh" .chezmoi.hostname)) }}
source {{ .chezmoi.homeDir }}/.keychain/{{ .chezmoi.hostname }}-sh
{{- end }}
{{- end }}
{{- end }}

{{- if lookPath "gpg-connect-agent" }}
# Start gpg-agent if available
export GPG_TTY=$(tty)
gpg-connect-agent updatestartuptty /bye &> /dev/null
{{- end }}

{{- if lookPath "fastfetch" }}
# Display system info with fastfetch if available
fastfetch
{{- end }}

# ========================================
# Prompt Configuration
# ========================================

# Enable Powerlevel10k instant prompt
# Should stay close to the top of ~/.zshrc
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Source Prezto
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

# Set terminal type
export TERM=xterm-256color

# Set editor variables
{{- if lookPath "nvim" }}
export EDITOR=nvim
export VISUAL=nvim
{{- else }}
export EDITOR=vim
export VISUAL=vim
{{- end }}

# Add local bin to PATH
if [[ -d "$HOME/.local/bin" ]] && [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
  export PATH="$PATH:$HOME/.local/bin"
fi

# Homebrew setup (OS-specific)
{{- $brew_prefix := "" }}
{{- if eq .chezmoi.os "darwin" }}
{{- $brew_prefix = "/opt/homebrew" }}
{{- else if eq .chezmoi.os "linux" }}
{{- $brew_prefix = "/home/linuxbrew/.linuxbrew" }}
{{- end }}
{{- if and (not (empty $brew_prefix)) (stat $brew_prefix) }}
eval "$({{ $brew_prefix }}/bin/brew shellenv)"
{{- end }}

{{- if lookPath "vivid" }}
# Set LS_COLORS with vivid
export LS_COLORS="$(vivid generate molokai)"
{{- end }}

{{- if and (eq .chezmoi.os "darwin") (stat "/opt/homebrew/bin/gls") }}
# macOS-specific ls alias
alias ls="/opt/homebrew/bin/gls --color"
{{- end }}

# Source custom aliases
if [[ -f "$HOME/.aliases" ]]; then
  source "$HOME/.aliases"
fi

# History search keybinding
bindkey '^R' history-incremental-search-backward

# ========================================
# Powerlevel10k Configuration
# ========================================

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh
[[ -f ~/.p10k.zsh ]] && source ~/.p10k.zsh

# ========================================
# End of Configuration
# ========================================