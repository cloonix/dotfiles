# ========================================
# Zsh Configuration File
# ========================================

# ========================================
# Homebrew Setup (must be early for PATH)
# ========================================

{{- if eq .chezmoi.os "darwin" }}
if [ -f "/opt/homebrew/bin/brew" ]; then
  eval "$(/opt/homebrew/bin/brew shellenv)"
fi
{{- else if eq .chezmoi.os "linux" }}
if [ -f "/home/linuxbrew/.linuxbrew/bin/brew" ]; then
  eval "$(/home/linuxbrew/.linuxbrew/bin/brew shellenv)"
fi
{{- end }}

# ========================================
# Agent Setup
# ========================================

# Start ssh-agent on login (Linux-specific)
{{- if eq .chezmoi.os "linux" }}
if command -v keychain >/dev/null 2>&1; then
  if [ -f "{{ .chezmoi.homeDir }}/.ssh/id_ed25519" ]; then
    keychain --nogui {{ .chezmoi.homeDir }}/.ssh/id_ed25519
  elif [ -f "{{ .chezmoi.homeDir }}/.ssh/id_rsa" ]; then
    keychain --nogui {{ .chezmoi.homeDir }}/.ssh/id_rsa
  fi
  if [ -f "{{ .chezmoi.homeDir }}/.keychain/{{ .chezmoi.hostname }}-sh" ]; then
    source {{ .chezmoi.homeDir }}/.keychain/{{ .chezmoi.hostname }}-sh
  fi
fi
{{- end }}

# Start gpg-agent if available
if command -v gpg-connect-agent >/dev/null 2>&1; then
  export GPG_TTY=$(tty)
  gpg-connect-agent updatestartuptty /bye &> /dev/null
fi

# Display system info with fastfetch if available
if command -v fastfetch >/dev/null 2>&1; then
  fastfetch
fi

# ========================================
# Prompt Configuration
# ========================================

# Enable Powerlevel10k instant prompt
# Should stay close to the top of ~/.zshrc
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Source Prezto
if [[ -s "${ZDOTDIR:-$HOME}/.zprezto/init.zsh" ]]; then
  source "${ZDOTDIR:-$HOME}/.zprezto/init.zsh"
fi

# ========================================
# Completion Configuration
# ========================================

fpath+=~/.zsh/completions
autoload -Uz compinit
compinit

# Set terminal type
export TERM=xterm-256color

# Set editor variables
if command -v nvim >/dev/null 2>&1; then
  export EDITOR=nvim
  export VISUAL=nvim
else
  export EDITOR=vim
  export VISUAL=vim
fi

# Add local bin to PATH
if [[ -d "$HOME/.local/bin" ]] && [[ ":$PATH:" != *":$HOME/.local/bin:"* ]]; then
  export PATH="$PATH:$HOME/.local/bin"
fi

# Add go bin to PATH
if [[ -d "$HOME/go/bin" ]] && [[ ":$PATH:" != *":$HOME/go/bin:"* ]]; then
  export PATH="$PATH:$HOME/go/bin"
fi

# opencode
if [[ -d "{{ .chezmoi.homeDir }}/.opencode/bin" ]] && [[ ":$PATH:" != *":{{ .chezmoi.homeDir }}/.opencode/bin:"* ]]; then
  export PATH="{{ .chezmoi.homeDir }}/.opencode/bin:$PATH"
fi

# Set LS_COLORS with vivid (if available)
if command -v vivid >/dev/null 2>&1; then
  export LS_COLORS="$(vivid generate molokai)"
fi

{{- if eq .chezmoi.os "darwin" }}
# macOS-specific ls alias
if [ -f "/opt/homebrew/bin/gls" ]; then
  alias ls="/opt/homebrew/bin/gls --color"
fi
{{- end }}

# Source custom aliases
if [[ -f "$HOME/.aliases" ]]; then
  source "$HOME/.aliases"
fi

# History search keybinding
bindkey '^R' history-incremental-search-backward

# ========================================
# Powerlevel10k Configuration
# ========================================

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh
[[ -f ~/.p10k.zsh ]] && source ~/.p10k.zsh

# ========================================
# End of Configuration
# ========================================
