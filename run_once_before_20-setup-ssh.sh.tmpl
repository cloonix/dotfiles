#!/usr/bin/env bash
{{ template "helpers.sh" . }}

section "SSH Setup"

printf "GitHub username (or press Enter to skip): "
read -r github_username

if [ -z "$github_username" ]; then
    warn "Skipped"
    exit 0
fi

ssh_dir="{{ .chezmoi.homeDir }}/.ssh"
auth_file="$ssh_dir/authorized_keys"

mkdir -p "$ssh_dir"

if curl -fsSL "https://github.com/$github_username.keys" -o /tmp/github_keys 2>/dev/null && [ -s /tmp/github_keys ]; then
    [ -f "$auth_file" ] && cp "$auth_file" "${auth_file}.backup.$(date +%s)"

    added=0
    while IFS= read -r key; do
        if [ -n "$key" ] && ! grep -Fxq "$key" "$auth_file" 2>/dev/null; then
            echo "$key" >> "$auth_file"
            ((added++))
        fi
    done < /tmp/github_keys

    chmod 700 "$ssh_dir" && chmod 600 "$auth_file"
    success "Added $added SSH key(s) from $github_username"
    rm -f /tmp/github_keys
else
    warn "No keys found for $github_username"
fi
